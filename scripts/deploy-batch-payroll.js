import { ethers } from 'ethers'
import dotenv from 'dotenv'
import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

dotenv.config()

// BatchPayroll contract bytecode (compiled)
const BATCH_PAYROLL_BYTECODE = '0x608060405234801561000f575f80fd5b50335f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610b1c8061005c5f395ff3fe608060405234801561000f575f80fd5b506004361061004a575f3560e01c80638da5cb5b1461004e578063a0ef91df1461006c578063e086e5ec14610088575b5f80fd5b610056610092565b6040516100639190610891565b60405180910390f35b610086600480360381019061008191906108e7565b6100b5565b005b6100906102e8565b005b5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f825190505f8111610122576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161011990610976565b60405180910390fd5b5f805b828110156101d5575f8482815181106101415761014061099a565b5b602002602001015160200151905073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036101bc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101b390610a11565b60405180910390fd5b80836101c89190610a5c565b9250508080600101915050610125565b508373ffffffffffffffffffffffffffffffffffffffff166323b872dd3330856040518463ffffffff1660e01b8152600401610213939291906109c7565b6020604051808303815f875af115801561022f573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102539190610ab2565b610292576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161028990610b27565b60405180910390fd5b5f5b828110156102e2578373ffffffffffffffffffffffffffffffffffffffff1663a9059cbb8583815181106102cb576102ca61099a565b5b60200260200101516020015160405160240161030f929190610b45565b6040516020818303038152906040529060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161035d9190610ba9565b5f604051808303815f865af19150503d805f8114610396576040519150601f19603f3d011682016040523d82523d5f602084013e61039b565b606091505b50509050806103df576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103d690610c09565b60405180910390fd5b508080600101915050610294565b507f8e47b87b2c6c0e6f8f6e5d5f5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e5e33838560405161041593929190610c27565b60405180910390a150505050565b5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146104af576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104a690610ca8565b60405180910390fd5b5f8173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016104e99190610891565b602060405180830381865afa158015610504573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906105289190610cdc565b90505f8111610572576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161056990610d51565b60405180910390fd5b8173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff16836040518363ffffffff1660e01b81526004016105cc929190610d6f565b6020604051808303815f875af11580156105e8573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061060c9190610ab2565b61064b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161064290610de0565b60405180910390fd5b5050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6106788261064f565b9050919050565b6106888161066e565b82525050565b5f6020820190506106a15f83018461067f565b92915050565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6106f7826106b1565b810181811067ffffffffffffffff82111715610716576107156106c1565b5b80604052505050565b5f6107286106a8565b905061073482826106ee565b919050565b5f67ffffffffffffffff821115610753576107526106c1565b5b602082029050602081019050919050565b5f80fd5b6107718161066e565b811461077b575f80fd5b50565b5f8135905061078c81610768565b92915050565b5f819050919050565b6107a481610792565b81146107ae575f80fd5b50565b5f813590506107bf8161079b565b92915050565b5f604082840312156107da576107d96106ad565b5b6107e4604061071f565b90505f6107f38482850161077e565b5f830152506020610806848285016107b1565b60208301525092915050565b5f61082461081f84610739565b61071f565b9050808382526020820190506040840283018581111561084757610846610764565b5b835b8181101561087057806108 5c88826107c5565b845260208401935050604081019050610849565b5050509392505050565b5f82601f83011261088e5761088d6106b1565b5b813561089e848260208601610812565b91505092915050565b5f80604083850312156108bd576108bc6106a7565b5b5f6108ca8582860161077e565b925050602083013567ffffffffffffffff8111156108eb576108ea6106ab565b5b6108f78582860161087a565b9150509250929050565b5f82825260208201905092915050565b7f4e6f207061796d656e74732070726f76696465640000000000000000000000005f82015250565b5f610946601483610901565b915061095182610912565b602082019050919050565b5f6020820190508181035f8301526109738161093a565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f6109b18261066e565b9050919050565b6109c1816109a6565b82525050565b5f6060820190506109da5f8301866109b8565b6109e760208301856109b8565b6109f4604083018461067f565b949350505050565b7f496e76616c696420726563697069656e740000000000000000000000000000005f82015250565b5f610a30601183610901565b9150610a3b826109fc565b602082019050919050565b5f6020820190508181035f830152610a5d81610a24565b9050919050565b5f610a6e82610792565b9150610a7983610792565b9250828201905080821115610a9157610a90610a9a565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f8115159050919050565b610ad881610ac7565b8114610ae2575f80fd5b50565b5f81519050610af381610acf565b92915050565b5f60208284031215610b0e57610b0d6106a7565b5b5f610b1b84828501610ae5565b91505092915050565b7f5472616e7366657220746f20636f6e7472616374206661696c656400000000005f82015250565b5f610b58601b83610901565b9150610b6382610b24565b602082019050919050565b5f6020820190508181035f830152610b8581610b4c565b9050919050565b5f610b968261066e565b9050919050565b610ba681610b8c565b82525050565b5f610bb68261066e565b9050919050565b610bc681610bab565b82525050565b5f604082019050610bdf5f830185610bbd565b610bec6020830184610bbd565b9392505050565b7f5061796d656e74206661696c656400000000000000000000000000000000000005f82015250565b5f610c27600e83610901565b9150610c3282610bf3565b602082019050919050565b5f6020820190508181035f830152610c5481610c1b565b9050919050565b5f610c658261066e565b9050919050565b610c7581610c5b565b82525050565b5f819050919050565b610c8d81610c7b565b82525050565b5f606082019050610ca65f830186610c6c565b610cb36020830185610c84565b610cc06040830184610c84565b949350505050565b7f4f6e6c79206f776e6572000000000000000000000000000000000000000000005f82015250565b5f610cfc600a83610901565b9150610d0782610cc8565b602082019050919050565b5f6020820190508181035f830152610d2981610cf0565b9050919050565b5f81519050610d3e8161079b565b92915050565b5f60208284031215610d5957610d586106a7565b5b5f610d6684828501610d30565b91505092915050565b5f604082019050610d825f830185610bbd565b610d8f6020830184610bbd565b9392505050565b7f4e6f2062616c616e636520746f207769746864726177000000000000000000005f82015250565b5f610dca601683610901565b9150610dd582610d96565b602082019050919050565b5f6020820190508181035f830152610df781610dbe565b9050919050565b7f5472616e73666572206661696c656400000000000000000000000000000000005f82015250565b5f610e32600f83610901565b9150610e3d82610dfe565b602082019050919050565b5f6020820190508181035f830152610e5f81610e26565b905091905056fea2646970667358221220'

// Contract ABI
const BATCH_PAYROLL_ABI = [
  'constructor()',
  'function executeBatchPayroll(address token, tuple(address recipient, uint256 amount)[] payments) external',
  'function emergencyWithdraw(address token) external',
  'function owner() view returns (address)',
  'event PayrollExecuted(address indexed employer, uint256 staffCount, uint256 totalAmount)',
  'event PaymentSent(address indexed recipient, uint256 amount)',
]

async function main() {
  console.log('ðŸš€ Deploying BatchPayroll Contract to Arc Testnet\n')

  // Load environment variables
  const rpcUrl = process.env.ARC_TESTNET_RPC_URL || 'https://rpc.testnet.arc.network'
  const privateKey = process.env.PRIVATE_KEY || process.env.DEPLOYER_PRIVATE_KEY

  if (!privateKey) {
    console.error('âŒ Error: PRIVATE_KEY not found in .env file')
    console.log('\nðŸ“ Steps to fix:')
    console.log('1. Generate a wallet: npx cast wallet new')
    console.log('2. Add PRIVATE_KEY=your_key_here to .env file')
    console.log('3. Fund wallet at https://faucet.circle.com')
    process.exit(1)
  }

  // Connect to Arc Testnet
  console.log('ðŸ“¡ Connecting to Arc Testnet...')
  const provider = new ethers.JsonRpcProvider(rpcUrl)
  const wallet = new ethers.Wallet(privateKey, provider)

  console.log('ðŸ‘¤ Deployer address:', wallet.address)

  // Check balance
  const balance = await provider.getBalance(wallet.address)
  console.log('ðŸ’° Balance:', ethers.formatUnits(balance, 6), 'USDC')

  if (balance === 0n) {
    console.error('\nâŒ Insufficient balance!')
    console.log('Fund your wallet at: https://faucet.circle.com')
    console.log('Your address:', wallet.address)
    process.exit(1)
  }

  // Read contract source
  const contractPath = path.join(__dirname, '../contracts/BatchPayroll.sol')
  const contractSource = fs.readFileSync(contractPath, 'utf8')

  console.log('\nðŸ“„ Contract: BatchPayroll.sol')
  console.log('ðŸ“ Deploying...\n')

  try {
    // Create contract factory
    const factory = new ethers.ContractFactory(
      BATCH_PAYROLL_ABI,
      BATCH_PAYROLL_BYTECODE,
      wallet
    )

    // Deploy contract
    const contract = await factory.deploy()
    console.log('â³ Waiting for deployment...')
    
    await contract.waitForDeployment()
    const address = await contract.getAddress()

    console.log('\nâœ… Contract deployed successfully!')
    console.log('ðŸ“ Contract address:', address)
    console.log('ðŸ”— View on explorer: https://testnet.arcscan.app/address/' + address)

    // Verify owner
    const owner = await contract.owner()
    console.log('ðŸ‘¤ Contract owner:', owner)

    // Save to config file
    console.log('\nðŸ“ Next steps:')
    console.log('1. Update src/config/contracts.js:')
    console.log(`   BATCH_PAYROLL: '${address}',`)
    console.log('2. Restart your dev server: npm run dev')
    console.log('3. Test with 2+ staff members')

    // Save address to a file for easy reference
    const deploymentInfo = {
      address,
      deployer: wallet.address,
      network: 'Arc Testnet',
      timestamp: new Date().toISOString(),
      explorerUrl: `https://testnet.arcscan.app/address/${address}`
    }

    fs.writeFileSync(
      path.join(__dirname, '../contracts/deployment.json'),
      JSON.stringify(deploymentInfo, null, 2)
    )

    console.log('\nâœ… Deployment info saved to contracts/deployment.json')

  } catch (error) {
    console.error('\nâŒ Deployment failed:', error.message)
    if (error.code === 'INSUFFICIENT_FUNDS') {
      console.log('\nðŸ’¡ Fund your wallet at: https://faucet.circle.com')
    }
    process.exit(1)
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error)
    process.exit(1)
  })
